name: Update AppleBlox Casks

on:
  schedule:
    - cron: "0 0 * * *" # Run daily
  workflow_dispatch: # Allow manual trigger

jobs:
  bump-casks:
    name: Update AppleBlox Casks
    runs-on: macos-26
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Debug Environment
        run: |
          echo "::group::System Information"
          echo "Time: $(date)"
          if [[ "$OSTYPE" == "darwin"* ]]; then
            echo "OS: macOS"
            sw_vers
          else
            echo "OS: Linux"
            cat /etc/os-release
          fi
          echo "Disk Usage:"
          df -h
          echo "::endgroup::"

          echo "::group::Environment Variables"
          env | sort
          echo "::endgroup::"

      - name: Update Casks
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: "AppleBlox/appleblox"
        run: |
          log_cmd() {
            local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
            echo "[$timestamp] [exec] $*" >&2
            echo "[$timestamp] [info] Command ran with $(($# - 1)) parameters" >&2
            "$@"
          }

          # Define the update_cask function to dry up the logic
          update_cask() {
            local CASK_NAME=$1
            local CASK_FILE="Casks/${CASK_NAME}.rb"
            local NEW_VERSION=$2
            local SHA256_ARM=$3
            local SHA256_INTEL=$4

            echo "::group::Updating ${CASK_NAME} to ${NEW_VERSION}"
            
            echo "[debug] --- File Content Before ---"
            cat "${CASK_FILE}"
            echo "[debug] -------------------------"

            CURRENT_VERSION=$(grep -Eo 'version ".+"' "${CASK_FILE}" | cut -d '"' -f 2)
            echo "[debug] Current version: ${CURRENT_VERSION}"
            echo "[debug] New version    : ${NEW_VERSION}"

            if [ "${CURRENT_VERSION}" != "${NEW_VERSION}" ]; then
              echo "[debug] Version mismatch detected. Patching..."
              
              # Patch SHA256 values using ruby for multiline block matching
              log_cmd ruby -i -pe "gsub(/sha256 \".*\"/, \"sha256 \\\"${SHA256_ARM}\\\"\") if /on_arm/ .. /end/" "${CASK_FILE}"
              log_cmd ruby -i -pe "gsub(/sha256 \".*\"/, \"sha256 \\\"${SHA256_INTEL}\\\"\") if /on_intel/ .. /end/" "${CASK_FILE}"
              
              # Patch version string
              if [[ "$OSTYPE" == "darwin"* ]]; then
                log_cmd sed -i "" "s|${CURRENT_VERSION}|${NEW_VERSION}|g" "${CASK_FILE}"
              else
                log_cmd sed -i "s|${CURRENT_VERSION}|${NEW_VERSION}|g" "${CASK_FILE}"
              fi
              
              echo "[debug] --- File Content After ---"
              cat "${CASK_FILE}"
              echo "[debug] ------------------------"

              echo "[debug] Staging changes for ${CASK_FILE}"
              log_cmd git add "${CASK_FILE}"
            else
              echo "[debug] ${CASK_NAME} is already at the latest version."
            fi
            
            echo "::endgroup::"
          }

          echo "--- STABLE BUILD ---"
          STABLE_VERSION=$(log_cmd gh release list -R "${REPO}" --limit 1 --json tagName -q '.[] | .tagName')
          if [ -z "${STABLE_VERSION}" ]; then
            echo "[error] Could not determine latest stable version" >&2
            exit 1
          fi
          echo "[debug] Latest Stable: ${STABLE_VERSION}"

          CURRENT_STABLE_VERSION=$(grep -Eo 'version ".+"' "Casks/appleblox.rb" | cut -d '"' -f 2)
          if [ "${CURRENT_STABLE_VERSION}" == "${STABLE_VERSION}" ]; then
            echo "[debug] appleblox is already at the latest version (${STABLE_VERSION}). Skipping update."
          else
            # Fetch stable assets
            echo "[debug] Fetching assets for version ${STABLE_VERSION}"
            STABLE_ASSETS=($(log_cmd gh release view "${STABLE_VERSION}" -R "${REPO}" --json assets -q '.assets[] | .name + ":" + .digest'))

            for asset in "${STABLE_ASSETS[@]}"; do
              case "${asset}" in
                *arm64.dmg*)
                  STABLE_SHA_ARM=$(echo "${asset}" | cut -d':' -f3)
                  echo "[debug] Found ARM asset: ${asset%%:*} (SHA: $STABLE_SHA_ARM)"
                  ;;
                *x64.dmg*)
                  STABLE_SHA_INTEL=$(echo "${asset}" | cut -d':' -f3)
                  echo "[debug] Found Intel asset: ${asset%%:*} (SHA: $STABLE_SHA_INTEL)"
                  ;;
              esac
            done

            if [ -z "${STABLE_SHA_ARM}" ] || [ -z "${STABLE_SHA_INTEL}" ]; then
              echo "[error] Missing stable assets for ${STABLE_VERSION}" >&2
              exit 1
            fi

            update_cask "appleblox" "${STABLE_VERSION}" "${STABLE_SHA_ARM}" "${STABLE_SHA_INTEL}"
          fi

          echo ""
          echo "--- DEV BUILD ---"
          DEV_VERSION=$(log_cmd curl -s "https://raw.githubusercontent.com/${REPO}/dev/package.json" | jq -r .version)
          if [ -z "${DEV_VERSION}" ] || [ "${DEV_VERSION}" == "null" ]; then
            echo "[error] Could not determine latest dev version" >&2
            exit 1
          fi
          echo "[debug] Latest Dev: ${DEV_VERSION}"

          CURRENT_DEV_VERSION=$(grep -Eo 'version ".+"' "Casks/appleblox@dev.rb" | cut -d '"' -f 2)
          if [ "${CURRENT_DEV_VERSION}" == "${DEV_VERSION}" ]; then
            echo "[debug] appleblox@dev is already at the latest version (${DEV_VERSION}). Skipping update."
          else
            # Download dev builds in parallel to save time using nightly.link
            fetch_dev_download() {
              local arch=$1
              local url="https://nightly.link/${REPO}/workflows/build/dev/AppleBlox-${DEV_VERSION}_${arch}.dmg.zip"
              echo "[debug] Downloading ${arch} from ${url}" >&2
              log_cmd curl -sL "${url}" -o "dev_${arch}.zip"
            }

            fetch_dev_download "arm64" &
            fetch_dev_download "x64" &
            wait

            DEV_SHA_ARM=$(log_cmd shasum -a 256 "dev_arm64.zip" | awk '{print $1}')
            DEV_SHA_INTEL=$(log_cmd shasum -a 256 "dev_x64.zip" | awk '{print $1}')


            if [ -z "${DEV_SHA_ARM}" ] || [ -z "${DEV_SHA_INTEL}" ]; then
              echo "[error] Missing dev assets for ${DEV_VERSION}" >&2
              exit 1
            fi

            update_cask "appleblox@dev" "${DEV_VERSION}" "${DEV_SHA_ARM}" "${DEV_SHA_INTEL}"

            # Cleanup
            log_cmd rm -f dev_*.zip
          fi

      - name: Commit and Push Changes
        run: |
          log_cmd() {
            local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
            echo "[$timestamp] [exec] $*" >&2
            echo "[$timestamp] [info] Command ran with $(($# - 1)) parameters" >&2
            "$@"
          }

          echo "[debug] Checking for changes..."
          log_cmd git status

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            echo "[debug] Diff of changes to be committed:"
            git diff --cached
            
            log_cmd git config --global user.name "github-actions[bot]"
            log_cmd git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
            log_cmd git commit -m "chore: update appleblox casks"
            log_cmd git push
          fi
