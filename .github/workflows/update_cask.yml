name: Update AppleBlox Casks

on:
  schedule:
    - cron: "0 0 * * *" # Run daily
  workflow_dispatch: # Allow manual trigger

jobs:
  bump-casks:
    name: Update AppleBlox Casks
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update Casks
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: "AppleBlox/appleblox"
        run: |
          # Define the update_cask function to dry up the logic
          update_cask() {
            local CASK_NAME=$1
            local CASK_FILE="Casks/${CASK_NAME}.rb"
            local NEW_VERSION=$2
            local SHA256_ARM=$3
            local SHA256_INTEL=$4

            echo "::group::Updating ${CASK_NAME} to ${NEW_VERSION}"
            
            CURRENT_VERSION=$(grep -Eo 'version ".+"' "${CASK_FILE}" | cut -d '"' -f 2)
            echo "[debug] Current version: ${CURRENT_VERSION}"
            echo "[debug] New version    : ${NEW_VERSION}"

            if [ "${CURRENT_VERSION}" != "${NEW_VERSION}" ]; then
              echo "[debug] Version mismatch detected. Patching..."
              
              # Patch SHA256 values using ruby for multiline block matching
              ruby -i -pe "gsub(/sha256 \".*\"/, \"sha256 \\\"${SHA256_ARM}\\\"\") if /on_arm/ .. /end/" "${CASK_FILE}"
              ruby -i -pe "gsub(/sha256 \".*\"/, \"sha256 \\\"${SHA256_INTEL}\\\"\") if /on_intel/ .. /end/" "${CASK_FILE}"
              
              # Patch version string
              sed -i "" "s/${CURRENT_VERSION}/${NEW_VERSION}/g" "${CASK_FILE}"
              
              echo "[debug] Staging changes for ${CASK_FILE}"
              git add "${CASK_FILE}"
            else
              echo "[debug] ${CASK_NAME} is already at the latest version."
            fi
            
            echo "::endgroup::"
          }

          echo "--- STABLE BUILD ---"
          STABLE_VERSION=$(gh release list -R "${REPO}" --limit 1 --json tagName -q '.[] | .tagName')
          echo "[debug] Latest Stable: ${STABLE_VERSION}"

          # Fetch stable assets
          # Note: handling both AppleBlox-VERSION_ARCH.dmg and AppleBlox_VERSION_ARCH.dmg
          STABLE_ASSETS=($(gh release view "${STABLE_VERSION}" -R "${REPO}" --json assets -q '.assets[] | .name + ":" + .digest'))

          for asset in "${STABLE_ASSETS[@]}"; do
            case "${asset}" in
              *arm64.dmg*)
                STABLE_SHA_ARM=$(echo "${asset}" | cut -d':' -f3)
                ;;
              *x64.dmg*)
                STABLE_SHA_INTEL=$(echo "${asset}" | cut -d':' -f3)
                ;;
            esac
          done

          update_cask "appleblox" "${STABLE_VERSION}" "${STABLE_SHA_ARM}" "${STABLE_SHA_INTEL}"

          echo ""
          echo "--- DEV BUILD ---"
          DEV_VERSION=$(curl -s "https://raw.githubusercontent.com/${REPO}/dev/package.json" | jq -r .version)
          echo "[debug] Latest Dev: ${DEV_VERSION}"

          # Download and compute hashes for dev builds (nightly.link)
          # nighty.link uses AppleBlox-VERSION_ARCH.dmg.zip

          fetch_dev_sha() {
            local arch=$1
            local url="https://nightly.link/${REPO}/workflows/build/dev/AppleBlox-${DEV_VERSION}_${arch}.dmg.zip"
            echo "[debug] Downloading ${arch} from ${url}"
            curl -sL "${url}" -o "dev_${arch}.zip"
            shasum -a 256 "dev_${arch}.zip" | awk '{print $1}'
          }

          DEV_SHA_ARM=$(fetch_dev_sha "arm64")
          DEV_SHA_INTEL=$(fetch_dev_sha "x64")

          update_cask "appleblox@dev" "${DEV_VERSION}" "${DEV_SHA_ARM}" "${DEV_SHA_INTEL}"

          # Cleanup
          rm -f dev_*.zip

      - name: Commit and Push Changes
        run: |
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git commit -m "chore: update appleblox casks"
            git push
          fi
